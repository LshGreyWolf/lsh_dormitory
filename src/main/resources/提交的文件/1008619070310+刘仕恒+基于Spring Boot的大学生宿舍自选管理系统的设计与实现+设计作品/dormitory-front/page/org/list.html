<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main" style="width: 250px;position: absolute;left: 0px">

        <form class="layui-form layui-form-pane" action="" id="grade1">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width: 250px">
                        <select name="grade" id="grade" lay-filter="selectGrade">
                            <option value="">请选择年级</option>
                        </select>
                    </div>
                </div>
            </div>
        </form>


        <div class="layui-btn-container" style="margin-bottom: 26px">
<!--            <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add">-->
<!--                <i class="layui-icon layui-icon-add-circle"></i>-->
<!--                新增-->
<!--            </button>-->
<!--            <button class="layui-btn layui-btn-sm layui-btn-normal data-update-btn" lay-event="update">-->
<!--                <i class="layui-icon layui-icon-edit"></i>-->
<!--                修改-->
<!--            </button>-->
<!--            <button class="layui-btn layui-btn-sm layui-btn-danger data-delete-btn" lay-event="delete">-->
<!--                <i class="layui-icon layui-icon-delete"></i>-->
<!--                删除-->
<!--            </button>-->
        </div>
        <div class="ztree" id="ztree" ></div>


    </div>

    <div class="layuimini-main" style="left:270px;position: absolute;right:0px;float: right">
        <div class="layui-form layuimini-form" lay-filter="setForm">

            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">

                        <div class="layui-inline">
                            <label class="layui-form-label">组织名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="name" autocomplete="off" class="layui-input" style="width: 180px"
                                       placeholder="请输入组织名称">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary" lay-submit
                                    lay-filter="data-search-btn"><i class="layui-icon"></i> 搜 索
                            </button>
                            <button type="reset" class="layui-btn layui-btn-primary">
                                <i class="layui-icon">&#xe669;</i>重置
                            </button>
                        </div>
                    </div>
                </form>
                    </div>
            </div>


            <script type="text/html" id="toolbarDemo">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add">
                        <i class="layui-icon layui-icon-add-circle"></i>
                        新增
                    </button>

                    <button class="layui-btn layui-btn-sm layui-btn-danger data-delete-btn" lay-event="delete">
                        <i class="layui-icon layui-icon-delete"></i>
                        批量删除
                    </button>
                </div>
            </script>

            <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>

            <script type="text/html" id="currentTableBar">
                <a class="layui-btn layui-btn-normal layui-btn-xs data-count-edit" lay-event="edit">编辑</a>
                <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
            </script>

        </div>

    </div>
</div>
<style>
    #ztree {
        border: 1px solid #e6e6e6;
    }
</style>
<script>
    layui.use(['form','miniPage','element','axios','ztree','selectOrg','table','miniAdmin'], function () {
        let $ = layui.jquery,
            form = layui.form,
            axios = layui.axios,
            miniAdmin = layui.miniAdmin,
            table = layui.table,
            ztree = layui.ztree,
            selectOrg = layui.selectOrg,
            miniPage = layui.miniPage;

        let setting = {
            data: {
                simpleData: {
                    enable: true
                }
            }
        };

        function loadTree(){
            //默认展示gradeId为1
            axios.post('org/tree',{gradeId:1,limit:10000}).then(function (response) {
                ztree.init($("#ztree"), setting,response.data);
            }).catch(function (error) {
                console.log(error);
            });
        }

        loadTree();
        window.reload = function(){
            loadTree();
            table.reload('currentTableId');
        }

        $('.data-add-btn').click(function () {
            let content = miniPage.getHrefContent('org/add.html');
            let openWH = miniPage.getOpenWidthHeight();
            let index = layer.open({
                title: '添加',
                type: 1,
                shade: 0.2,
                maxmin:true,
                shadeClose: true,
                area: [openWH[1] + 'px', openWH[1] + 'px'],
                content: content
            });
            $(window).on("resize", function () {
                layer.full(index);
            });
        });
        $('.data-update-btn').click(function () {
            let content = miniPage.getHrefContent('org/update.html');
            let openWH = miniPage.getOpenWidthHeight();
            let index = layer.open({
                title: '修改',
                type: 1,
                shade: 0.2,
                maxmin:true,
                shadeClose: true,
                area: [openWH[1] + 'px', openWH[1] + 'px'],
                content: content
            });

            let treeObj = ztree.getZTreeObj("ztree");
            let node = treeObj.getSelectedNodes()[0];


            form.val('updateForm',{
                id:node.id,
                name:node.name,
                parentId:node.pId,
            })
            $('#parentName').val(node.getParentNode().name)


            $(window).on("resize", function () {
                layer.full(index);
            });
        });


        $('.data-delete-btn').click(function () {
            let treeObj = ztree.getZTreeObj("ztree");
            let node = treeObj.getSelectedNodes()[0];
            console.log(node)
            if(node){
                layer.confirm('确认要删除吗', function (index) {
                    axios.get('org/delete?id='+node.id).then(function (response) {
                        loadTree();
                        layer.msg(response.msg);
                    }).catch(function (error) {
                        layer.msg(error);
                    });
                    layer.close(index);
                });
            }else{
                layer.msg("请选择要删除的数据");
            }
        });


        table.render({
            elem: '#currentTableId',
            method: 'post',
            url: 'org/queryByPage',
            toolbar: '#toolbarDemo',
            data: {gradeId:1},
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {type: "checkbox", width: 50},
                {field: 'id', width: 80, align: "center", title: 'ID'},
                {field: 'name',align: "center", title: '组织名称'},
                {field: 'type',align: "center", title: '类型', templet: function (row) {
                        if (row.type == 1) {
                            return '<span class="layui-badge layui-bg-gray">学院</span>';
                        } else if (row.type == 2){
                            return '<span class="layui-badge layui-bg-gray">系</span>';
                        }else if (row.type == 3){
                            return '<span class="layui-badge layui-bg-gray">专业</span>';
                        }else if (row.type == 4){
                            return '<span class="layui-badge layui-bg-gray">班级</span>';
                        }
                    }},
                {field: 'gradeId',align: "center", title: '年级',templet:'<div>{{d.gradeName}}</div>'},
                {field: 'status',align: "center", title: '状态',templet:function (row){
                    if (row.status ==0){
                        return'正常'
                    }else {
                        return '不正常'
                    }
                    }},
                {title: '操作', minWidth: 150, toolbar: '#currentTableBar', align: "center"},
            ]],
            page: true,
            skin: 'line'
        });


        // 监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            var result = JSON.stringify(data.field);
            //执行搜索重载
            table.reload('currentTableId', {
                where: data.field
            }, 'data');

            return false;
        });

        //渲染年级列表
        axios.post('grade/gradeQueryByPage', {}).then(function (res) {
            res.data.forEach(item => {
                let option =''
                if (item.id ==1){
                    option+= `<option value="${item.id}" data-id="${item.id}" selected> ${item.name}级</option>`
                }else {
                    option+= `<option value="${item.id}" data-id="${item.id}"> ${item.name}级</option>`
                }

                $('#grade').append(option);
            })
            form.render();
        })

        //选择年级，重载列表
        form.on("select(selectGrade)", function (data) {
            let gradeId = parseInt(data.value)
            table.reload('currentTableId', {
                where: {'gradeId': gradeId}
            }, 'data');

            axios.post("org/tree",{gradeId:gradeId,limit:1000}).then(function (res){
                ztree.init($("#ztree"), setting,res.data);
            })


        })

        table.on('toolbar(currentTableFilter)', function (obj) {
            if (obj.event === 'add') {   // 监听添加操作
                let content = miniPage.getHrefContent('org/add.html');
                let openWH = miniPage.getOpenWidthHeight();
                let index = layer.open({
                    title: '添加',
                    type: 1,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: [openWH[1] + 'px', openWH[1] + 'px'],
                    content: content
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            }  else if (obj.event === 'delete') { //删除操作
                let data = table.checkStatus('currentTableId').data;

                if (data.length == 0) {
                    layer.msg("请选择要删除的数据");
                } else {
                    layer.confirm('确认要删除吗', function (index) {

                        let arr = data.map(item => item.id);
                        axios.get('org/delete?ids=' + arr.join(",")).then(function (response) {
                            table.reload('currentTableId');

                            miniAdmin.success(response.msg)
                            loadTree();
                        }).catch(function (error) {
                            miniAdmin.error(error)
                        });
                        layer.close(index);
                    });
                }
            }
        });

        table.on('tool(currentTableFilter)', function (obj) {
            //data就是表单每一行的数据
            let data = obj.data;
            if (obj.event === 'edit') {
                let content = miniPage.getHrefContent('org/update.html');
                let openWH = miniPage.getOpenWidthHeight();
                let index = layer.open({
                    title: '修改',
                    type: 1,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: [openWH[1] + 'px', openWH[1] + 'px'],
                    content: content
                });
                form.val('updateForm',{
                    id:data.id,
                    name:data.name,
                    parentId:data.parentId,
                    type :data.type,
                    gradeId: data.gradeId
                })
                $("#gradeId2").val(data.gradeId)

                //编辑使，回显父级名称
                axios.post('/org/queryParentName',{ id:data.id}).then(function (res){
                    let parentName = res.msg
                    $('#parentName').val(parentName)
                })

                $(window).on("resize", function () {
                    layer.full(index);
                });
            } else if (obj.event === 'delete') {
                layer.confirm('确定要删除吗？', function (index) {

                    // 异步删除
                    let id = data.id
                    axios.get('org/delete?ids=' + id).then(function (response) {
                        table.reload('currentTableId');
                        miniAdmin.success(response.msg);
                    }).catch(function (error) {
                        miniAdmin.error(error);
                    });
                    layer.close(index);
                });
            }
        });
    });
</script>
