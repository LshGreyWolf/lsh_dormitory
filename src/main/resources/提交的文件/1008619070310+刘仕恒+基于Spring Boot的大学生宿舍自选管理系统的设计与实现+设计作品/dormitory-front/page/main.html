<style>
    .welcome .layui-card {
        border: 1px solid #f2f2f2;
        border-radius: 5px;
    }

    .welcome .icon {
        margin-right: 10px;
        color: #1aa094;
    }

    .welcome .icon-tip {
        color: #ff5722 !important;
    }

    .welcome .layuimini-qiuck-module a i {
        display: inline-block;
        width: 100%;
        height: 60px;
        line-height: 60px;
        text-align: center;
        border-radius: 2px;
        font-size: 30px;
        background-color: #F8F8F8;
        color: #333;
        transition: all .3s;
        -webkit-transition: all .3s;
    }

    .welcome .layuimini-qiuck-module a cite {
        position: relative;
        top: 2px;
        display: block;
        color: #666;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        font-size: 14px;
    }

    .welcome .welcome-module {
        width: 100%;
        height: 200px;
    }

    .welcome .main_btn > p {
        height: 40px;
    }

    .welcome .layuimini-notice {
        padding: 7px 16px;
        clear: both;
        font-size: 12px !important;
        cursor: pointer;
        position: relative;
        transition: background 0.2s ease-in-out;
    }

    .welcome .layuimini-notice-title, .layuimini-notice-label {
        padding-right: 70px !important;
        text-overflow: ellipsis !important;
        overflow: hidden !important;
        white-space: nowrap !important;
    }

    .welcome .layuimini-notice-extra {
        position: absolute;
        top: 50%;
        margin-top: -8px;
        right: 16px;
        display: inline-block;
        height: 16px;
        color: #999;
    }
</style>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main welcome">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md8">
                <div class="layui-row">
                    <div class="layui-card" style="overflow: scroll">
                        <div class="layui-card-header" ><i class="fa fa-warning icon"></i>数据统计</div>
                        <div class="layui-card-body">
                            <div class="welcome-module" >
                                <table class="layui-table" lay-skin="line">
                                    <tr>
                                        <th>楼宇</th>
                                        <th>宿舍数量</th>
                                        <th>入住人数</th>
                                        <th>闲置数量</th>
                                        <th>使用率</th>
                                    </tr>
                                    <tbody id="building-data"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-line-chart icon"></i>报表统计</div>
                        <div class="layui-card-body">
                            <div id="echarts-records" style="min-height:365px"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card" style="height: 230px;overflow: scroll">
                    <div class="layui-card-header"><i class="fa fa-bullhorn icon icon-tip"></i>系统公告</div>
                    <div class="layui-card-body layui-text" id="notice-data"></div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-pie-chart "
                                                      style="color: #40a9ff;margin-right: 10px"></i>使用率统计
                    </div>
                    <div class="layui-card-body">
                        <div id="echarts-records-pie" style="min-height:365px"></div>
                    </div>
                </div>
                <div class="layui-card" style="height: 50px">
                    <div class="layui-card-header"><i class="fa fa-keyboard-o "
                                                      style="color: #40a9ff;margin-right: 10px"></i>作者心语：
                        人才虽高，不务学问，不能致圣。
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="layuimini-main welcome" id="student" style="display: none">
        <div class="layui-row layui-col-space15">
            <p style="font-size: 20px; margin: 20px 20px 20px 20px;border-left: #00a2d4 solid thick;">宿舍概览</p>
            <div class="layui-col-xs12 layui-col-md3">

                <div class="layui-card top-panel">
                    <div class="layui-card-header" style="font-size: 15px">宿舍号</div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space5">
                            <div class="layui-col-xs9 layui-col-md9 top-panel-number" id="dormitoryNo"
                                 style="font-size: 20px">

                            </div>
                            <div class="layui-col-xs3 layui-col-md3 top-panel-tips">
                                <a class="fa fa-home "
                                   style="display:inline-block;height:95px;line-height:90px;text-align:center;font-size:40px;color: #4aca85"></a><br>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="layui-col-xs12 layui-col-md3">

                <div class="layui-card top-panel">
                    <div class="layui-card-header" style="font-size: 15px">所在楼层</div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space5">
                            <div class="layui-col-xs9 layui-col-md9 top-panel-number" id="storeyName"
                                 style="font-size: 20px">
                                fa-snowflake-o
                            </div>
                            <div class="layui-col-xs3 layui-col-md3 top-panel-tips">
                                <a class="fa fa-map-marker icon"
                                   style="display:inline-block;height:95px;line-height:90px;text-align:center;font-size:40px;color: #4476A7"></a><br>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="layui-col-xs12 layui-col-md3">

                <div class="layui-card top-panel">
                    <div class="layui-card-header" style="font-size: 15px">宿舍楼</div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space5">
                            <div class="layui-col-xs9 layui-col-md9 top-panel-number" id="buildingName"
                                 style="font-size: 20px">

                            </div>
                            <div class="layui-col-xs3 layui-col-md3 top-panel-tips">
                                <a class="fa fa-building-o icon"
                                   style="display:inline-block;height:95px;line-height:90px;text-align:center;font-size:40px;color: #40a9ff"></a><br>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="layui-col-xs12 layui-col-md3">

                <div class="layui-card top-panel">
                    <div class="layui-card-header" style="font-size: 15px">选择日期</div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space5">
                            <div class="layui-col-xs9 layui-col-md9 top-panel-number" id="checkin"
                                 style="font-size: 20px">
<!--                                fa-hourglass-end-->
                            </div>
                            <div class="layui-col-xs3 layui-col-md3 top-panel-tips">
                                <a class="fa fa-calendar icon"
                                   style="display:inline-block;height:95px;line-height:90px;text-align:center;font-size:40px;color: #da4f49"></a><br>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="layui-row layui-col-space15">
            <p style="font-size: 20px;margin: 20px 20px 0px 20px;border-left: #00a2d4 solid thick;">当前宿舍选择</p>
            <div class="layuimini-main">


                <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>

            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['layer', 'echarts', 'axios', 'util', 'table'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            util = layui.util,
            axios = layui.axios,
            table = layui.table,
            echarts = layui.echarts;

        //渲染宿舍概览的数据
        axios.get('studentMain/selectStudentDormitory').then(function (res) {
            if (res.data != null) {
                $("#buildingName").text(res.data.buildingName)
                $("#dormitoryNo").text(res.data.dormitoryNo)
                $("#checkin").text(res.data.checkin)
                $("#storeyName").text(res.data.storeyName)
            } else {
                $("#buildingName").text("暂无")
                $("#dormitoryNo").text("暂无")
                $("#checkin").text("暂无")
                $("#storeyName").text("暂无")
            }

        })
        table.render({
            elem: '#currentTableId',
            method: 'post',
            url: 'studentMain/selectRoommate',
            cols: [[
                {
                    field: 'studentId',
                    title: '姓名',
                    align: "center",
                    width: 100,
                    templet: '<div>{{d.student.name}}</div>'
                },
                {field: 'stuNo', title: '学号', align: "center", templet: '<div>{{d.student.stuNo}}</div>'},
                {
                    field: 'studentId',
                    title: '手机号',
                    align: "center",
                    width: 150,
                    templet: '<div>{{d.student.phone}}</div>'
                },
                {field: 'dormitoryId', title: '宿舍号', align: "center", templet: '<div>{{d.dormitory.no}}</div>'},
                {
                    field: 'dormitoryId',
                    title: '宿舍楼层',
                    align: "center",
                    templet: '<div>{{d.dormitory.storey.name}}</div>'
                },
                {
                    field: 'dormitoryId',
                    title: '宿舍楼名称',
                    align: "center",
                    templet: '<div>{{d.dormitory.building.name}}</div>'
                },

                {
                    field: 'checkin', title: '选择时间', align: "center", width: 200,
                    templet: "<div>{{layui.util.toDateString(d.checkin, 'yyyy-MM-dd HH:mm:ss')}}</div>"
                }
            ]],
            skin: 'line'
        });
        if (store.getLoginType() == 1) {
            $('.welcome').hide()
            $("#student").show()
            return;
        }

        function loadBuilding() {
            axios.get('main/building', {}).then(function (response) {
                response.data.forEach(item => {
                    let html = `<tr>
                                <td >${item.name}</td>
                                <td>${item.all}</td>
                                <td>${item.used}</td>
                                <td>${item.unused}</td>
                                <td>${item.percent}%</td>
                            </tr>`

                    $('#building-data').append(html);
                })
            });
        }

        loadBuilding();

        function loadNotice() {
            axios.get('main/notice').then(function (response) {
                response.data.forEach(item => {
                    let html = `<div class="layuimini-notice">
                            <div class="layuimini-notice-title">${item.title}</div>
                            <div class="layuimini-notice-extra" >${item.createTime}</div>
                            <div class="layuimini-notice-content layui-hide">${item.content}</div>
                         </div>`

                    $('#notice-data').append(html);
                })

            });
        }

        loadNotice();


        /**
         * 查看公告信息
         **/
        $('body').on('click', '.layuimini-notice', function () {
            let title = $(this).children('.layuimini-notice-title').text(),
                noticeTime = $(this).children('.layuimini-notice-extra').text(),
                content = $(this).children('.layuimini-notice-content').html();

            let html = '<div style="padding:15px 20px; text-align:justify; line-height: 22px;border-bottom:1px solid #e2e2e2;background-color: #eeeeee;color: #222222;">\n' +
                '<div style="text-align: center;margin-bottom: 20px;font-weight: bold;border-bottom:1px solid #718fb5;padding-bottom: 5px"><h4 class="text-danger">' + title + '</h4></div>\n' +
                '<div style="font-size: 14px">' + content + '</div>\n' +
                '</div>\n';
            parent.layer.open({
                type: 1,
                title: '系统公告' + '<span style="float: right;right: 2px;font-size: 12px;color: #b1b3b9;margin-top: 1px">' + noticeTime + '</span>',
                area: '400px;',
                shade: 0.8,
                id: 'layuimini-notice',
                btn: ['取消'],
                btnAlign: 'c',
                moveType: 1,
                content: html
            });
        });


        /**
         * 报表功能
         */
        function loadReport() {
            axios.get('main/buildingLine', {}).then(function (response) {
                axios.get('main/building', {}).then(function (res) {
                    let name = res.data.map(item => item.name);
                    loadEchartsLine(name, response.data);
                })

            });
        }

        loadReport();

        function loadEchartsLine(name, data) {
            let echartsRecords = echarts.init(document.getElementById('echarts-records'), 'walden');
            let option =
                {

                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: data
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    toolbox: {
                        feature: {
                            saveAsImage: {}
                        }
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: name
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: data
                };
            echartsRecords.setOption(option);
            window.onresize = function () { // echarts 窗口缩放自适应
                echartsRecords.resize();
            }
        }

        function loadDormitoryRate() {
            axios.get('main/buildingRate', {}).then(function (res) {
                if (res.code == 200) {
                    let data = res.data
                    console.log(data)
                    loadEchartsPie(data)
                }
            })

        }

        loadDormitoryRate()

        function loadEchartsPie(data) {
            let echartsRecords = echarts.init(document.getElementById('echarts-records-pie'), 'walden');
            let option = {
                legend: {
                    top: 'bottom'
                },
                toolbox: {
                    show: true,
                    feature: {
                        mark: {show: true},
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                    }
                },
                series: [
                    {
                        name: 'Nightingale Chart',
                        type: 'pie',
                        radius: [50, 100],
                        center: ['50%', '50%'],
                        roseType: 'area',
                        itemStyle: {
                            borderRadius: 8
                        },
                        data: data
                    }
                ]
            };
            echartsRecords.setOption(option);
            window.onresize = function () { // echarts 窗口缩放自适应
                echartsRecords.resize();
            }
        }

    });
</script>
