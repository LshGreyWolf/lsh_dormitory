
<div class="layuimini-main">
    <div class="layui-form layuimini-form">
        <!--        <p style="font-size: 20px; margin: 10px 20px 10px 10px;border-left: #00a2d4 solid thick;">宿舍选择</p>-->
        <ul class="dormitory"></ul>
    </div>

</div>
<style>
    .dormitory {
        height: 1200px;
    }

    .dormitory > li {
        width: 100%;
        clear: both;
        margin-bottom: 5px;
    }

    .dormitory > li > p {
        height: 40px;
        background-color: #f8f8f8;
        line-height: 40px;
        font-size: 15px;
        cursor: pointer;
        padding-left: 10px;
        border: 1px solid #dddddd;
        border-radius: 4px;
    }

    .dormitory > li > p > span {
        float: right;
        margin-right: 10px;
    }

    .dormitory > li > p > span > button {
        cursor: pointer;
        color: #00998b;
        background: transparent;
        border: 0px;
        font-size: 20px;
    }

    .bed {
        display: none;
    }

    .bed li {
        float: left;
        width: 130px;
        height: 130px;
        border: 1px solid #f0f0f0;
        margin: 10px;
        text-align: center;
        color: #999999;
    }

    .bed li:hover {
        background-color: #f0f0f0;
    }

    .bed li i {
        font-size: 20px;
        cursor: pointer;
    }

    .bed li i:hover {
        color: #00998b;
        font-size: 20px;
        cursor: pointer;
    }
</style>
<script>
    layui.use(['form', 'table', 'axios', 'miniAdmin', 'util'], function () {
        let form = layui.form,
            layer = layui.layer,
            util = layui.util,
            miniAdmin = layui.miniAdmin,
            axios = layui.axios,
            $ = layui.$;

        form.render()

        //固定块
        util.fixbar({
            bar1: true
            , bar2: true
            , css: {right: 50, bottom: 100}
            , bgcolor: '#393D49'
            , click: function (type) {
                if (type === 'bar1') {
                    axios.post('selection/selectTimeByStudent', {}).then(function (res) {
                        console.log(res)
                        let startTime = res.data.startTime
                        let endTime = res.data.endTime
                        // $("#time").append('' + startTime + '——' + endTime + '');
                        layer.msg("选择时间为："+'' + startTime + '—' + endTime + '')
                    })

                } else if (type === 'bar2') {
                    layer.msg('注意选择时间哦')
                }
            }
        });


        function loadDormitory() {
            axios.post('stu/selectDormitory', {}).then(function (response) {
                console.log(response)
                $('.dormitory').empty();
                if (response.data.length == 0) {
                    $('.dormitory').html("<p style='font-size: 20px; margin: 10px 20px 10px 10px; '>暂不能选择宿舍!请联系管理员</p>");
                    return;
                }
                response.data.forEach(item => {
                    let html = `<li>
                                  <p data-key="${item.id}">${item.buildingName}—${item.no}—${item.sex}
                                      <span>
                                      容量：${item.capacity}&nbsp;
                                      入住数量：${item.selectCount}
                                      </span>
                                  </p>
                                  <ul class="bed"></ul>
                              </li>`;
                    let htmlObj = $(html);
                    htmlObj.find('p').click(function () {
                        $(this).siblings().toggle(200);
                        loadBed($(this).data("key"), $(this).siblings(), item.studentList);
                    });
                    htmlObj.find('p').trigger('click');

                    $('.dormitory').append(htmlObj);
                });
            })
        }

        loadDormitory();

        function loadBed(dormitoryId, bedObj, studentList) {
            axios.post('bed/list/' + dormitoryId).then(function (res) {
                bedObj.empty()
                if (res.data.length == 0) {
                    bedObj.append('暂无床位信息');
                    return
                }
                let html = ''
                res.data.forEach(item => {
                    if (studentList.some(v => v.bedId == item.id)) {
                        html += `<li data-key="${item.id}">
                    <img src="../../images/bed2.png">
                    <p>床位:${item.bno}</p>
                    <p>已占用</p>
                     <input type="checkbox" checked disabled lay-skin="primary">
                    </li>`
                    } else {
                        html += `
                    <li data-key="${item.id}">
                    <img src="../../images/bed.png">
                    <p>床位:${item.bno}</p>
                    <p>&nbsp;</p>
                     <input type="checkbox" lay-filter="selectBed" bedId="${item.id}" dormitoryId ="${dormitoryId}" lay-skin="primary">
                    </li>
                    `}
                })
                $(bedObj).html(html);
                //渲染复选框
                form.render();

            })
        }

        form.on('checkbox(selectBed)', function (data) {

            let dormitoryId = $(data.elem).attr("dormitoryId")
            let bedId = $(data.elem).attr("bedId");
            layer.confirm('确认要选择该床位吗？', function (index) {
                axios.post("stu/selectDormitorySubmit", {dormitoryId: dormitoryId, bedId: bedId}).then(function (res) {
                    if (res.code == 200) {
                        miniAdmin.success(res.msg)
                    }
                    loadDormitory()
                    form.render()
                    layer.close(index);
                    form.render()
                }).catch(function (error) {
                    miniAdmin.error(error)
                    loadDormitory()

                });

            })
        })

    });
</script>
