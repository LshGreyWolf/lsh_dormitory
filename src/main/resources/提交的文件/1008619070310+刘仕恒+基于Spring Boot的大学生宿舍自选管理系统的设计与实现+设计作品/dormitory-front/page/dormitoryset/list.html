<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <p style="margin-left: 15px; font-size: 15px;color: #9F9F9F;margin-top: 5px;margin-bottom: 5px";>宿舍管理</p>
        <div style="margin:  10px" id="building">

        </div>

    </div>
    <div class="layuimini-main" style="width: 250px;position: absolute;left: 0px">
        <p style="margin-left: 1px; font-size: 14px;color: #1b1d21;margin-top: 5px;margin-bottom: 5px;border-left: #00998b solid thick ";>&nbsp;&nbsp;楼层</p>
        <ul class="storey"></ul>


    </div>
    <div class="layuimini-main" style="left:270px;position: absolute;right:0px;float: right">
        <div class="layui-form layuimini-form" lay-filter="setForm">

            <script type="text/html" id="toolbarDemo">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add">
                        <i class="layui-icon layui-icon-add-circle"></i>
                        新增
                    </button>

                    <button class="layui-btn layui-btn-sm layui-btn-danger data-delete-btn" lay-event="delete">
                        <i class="layui-icon layui-icon-delete"></i>
                        批量删除
                    </button>

                    <button class="layui-btn layui-btn-sm layui-btn-normal data-init-btn" lay-event="init">
                        <i class="layui-icon layui-icon-edit"></i>
                        宿舍初始化
                    </button>
                </div>
            </script>

            <table class="layui-hide" id="currentTableId" lay-filter="currentTableFilter"></table>

            <script type="text/html" id="currentTableBar">
                <a class="layui-btn layui-btn-normal layui-btn-xs data-count-edit" lay-event="edit">编辑</a>
                <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
            </script>

        </div>

    </div>
</div>
<style>

    .storey {
        margin: 0px;
        padding: 0px;
    }

    .storey li {
        height: 40px;
        line-height: 40px;
        border-bottom: 1px solid #f1f1f1;
        font-size: 16px;
        cursor: pointer;
        padding-left: 50px;
    }

    .storey > li > span {
        float: right;
        margin-right: 10px;
    }

    .storey > li > span > button {
        cursor: pointer;
        color: #00998b;
        background: transparent;
        border: 0px;
        font-size: 20px;
    }

    .storey-bg {
        background-color: #f0f0f0;
        color: #000000;
    }


    li {
        -webkit-user-select: none; /*谷歌 /Chrome*/
        -moz-user-select: none; /*火狐/Firefox*/
        -ms-user-select: none; /*IE 10+*/
        user-select: none;
    }
</style>

<script>
    layui.use(['form', 'miniPage', 'element', 'miniAdmin', 'table', 'axios'], function () {
        let $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            axios = layui.axios,
            miniAdmin = layui.miniAdmin,
            miniPage = layui.miniPage
        //定义全局变量，新增的时候回显楼宇和楼层
        let _buildingId;
        let _storeyId;

        function loadBuilding() {
            axios.post("building/BuildingQueryByPage", {}).then(function (res) {

                res.data.forEach(item => {

                    let btn = '<button class="layui-btn layui-btn-primary layui-btn-radius " data-key="' + item.id + '">' + item.name + '</button>'
                    let btnObj = $(btn)
                    btnObj.click(function () {

                        let buildingId = $(this).data('key')
                        $(this).removeClass('layui-btn-primary')
                        $(this).siblings().addClass('layui-btn-primary')

                        loadStory(buildingId)
                    })
                    $("#building").append(btnObj)

                })
                //触发点击事件(刷新显示第一个)
                $('#building button:first').trigger('click');

            }).catch(function (error) {
                console.log(error)
            })
        }

        loadBuilding()

        //加载楼层数据
        function loadStory(buildingId) {
            axios.post("storey/list/" + buildingId).then(function (res) {
                //切换楼宇的时候移除上一个楼宇的楼层的li
                $(".storey").empty()

                res.data.forEach(item => {

                    let btn = `<li data-key="${item.id}">${item.name} </li>`
                    let btnObj = $(btn)

                    btnObj.click(function () {
                        let storeyId = $(this).data('key')
                        $(this).siblings().removeClass('storey-bg')
                        $(this).addClass('storey-bg')
                        //点击楼层触发函数
                        loadDormitorySet(buildingId, storeyId)

                    })


                    $(".storey").append(btnObj)

                })
                //触发点击事件(刷新显示第一个)
                $('.storey li:first').trigger('click');
            })
        }


        //加载宿舍预选设置信息
        function loadDormitorySet(buildingId, storeyId) {
            _buildingId = buildingId;
            _storeyId = storeyId;
            table.render({
                elem: '#currentTableId',
                method: 'post',
                url: 'dormitorySet/queryDormitorySet',
                toolbar: '#toolbarDemo',
                data: {buildingId: buildingId, storeyId: storeyId},
                defaultToolbar: ['filter', 'exports', 'print'],
                cols: [[
                    {type: "checkbox", width: 50},
                    {field: 'id', width: 80, align: "center", title: 'ID'},
                    {field: 'prefix',align: "center", title: '前缀'},
                    {field: 'start', align: "center",title: '开始值'},
                    {field: 'end',align: "center", title: '结束值'},
                    {field: 'capacity', align: "center",title: '容量'},
                    {title: '操作', minWidth: 150, toolbar: '#currentTableBar', align: "center"},
                ]],
                page: true,
                skin: 'line'
            });
        }


        window.reload = function () {
            table.reload('currentTableId');
        }


        /**
         * toolbar事件监听
         */
        table.on('toolbar(currentTableFilter)', function (obj) {
            if (obj.event === 'add') {   // 监听添加操作
                let content = miniPage.getHrefContent('dormitoryset/add.html');
                let openWH = miniPage.getOpenWidthHeight();
                let index = layer.open({
                    title: '添加宿舍编号设置',
                    type: 1,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: [openWH[1] + 'px', openWH[1] + 'px'],

                    content: content
                });
                //赋值
                form.val('setAddForm', {
                    buildingId: _buildingId,
                    storeyId: _storeyId
                })

                $(window).on("resize", function () {
                    layer.full(index);
                });
            } else if (obj.event === 'delete') { //删除操作
                let data = table.checkStatus('currentTableId').data;
                if (data.length == 0) {
                    miniAdmin.error("请选择要删除的数据");
                } else {
                    layer.confirm('确认要删除吗？', function (index) {

                        let arr = data.map(item => item.id);
                        axios.get('dormitorySet/deleteDormitorySet?ids=' + arr.join(",")).then(function (response) {
                            table.reload('currentTableId');
                            miniAdmin.success(response.msg)
                        }).catch(function (error) {
                            miniAdmin.error(error)
                        });
                        layer.close(index);
                    });
                }
            }else if(obj.event === 'init'){//初始化...
                axios.post('dormitory/list',{buildingId:_buildingId,storeyId:_storeyId}).then(function (response) {
                    let message='';
                    console.log(response.data)
                    if(response.data.length>0){
                        message="已存在宿舍信息，初始化后原数据会丢失，";
                    }
                    layer.confirm(message+'确认初始化吗？', function (index) {
                        axios.post('dormitory/initDormitory',{buildingId:_buildingId,storeyId:_storeyId}).then(function (response) {
                            miniAdmin.success(response.msg);
                        }).catch(function (error) {
                            miniAdmin.error(error);
                        });
                        layer.close(index);
                    });
                }).catch(function (error) {
                    layer.msg(error);
                });
            }
        });

        table.on('tool(currentTableFilter)', function (obj) {
            //data就是表单每一行的数据
            let data = obj.data;
            if (obj.event === 'edit') {
                //指定点击编辑按钮跳转的html页面
                let content = miniPage.getHrefContent('dormitoryset/update.html');
                //获取页面的宽高
                let openWH = miniPage.getOpenWidthHeight();

                //打开编辑窗口
                let index = layer.open({
                    title: '编辑宿舍编号设置',
                    type: 1,
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: [openWH[1] + 'px', openWH[1] + 'px'],

                    content: content,
                });

                // 给表单赋值
                form.val('setUpdateForm',{
                    id:data.id,
                    buildingId:data.buildingId,
                    storeyId:data.storeyId,
                    prefix:data.prefix,
                    start:data.start,
                    end:data.end,
                    capacity:data.capacity,
                })

                $(window).on("resize", function () {
                    layer.full(index);
                });
                return false;
            } else if (obj.event === 'delete') {
                layer.confirm('确定要删除吗？', function (index) {

                    let id = data.id
                    axios.get('dormitorySet/deleteDormitorySet?ids=' + id).then(function (response) {
                        table.reload('currentTableId');
                        miniAdmin.success(response.msg);
                    }).catch(function (error) {
                        miniAdmin.error(error);
                    });
                    layer.close(index);
                });
            }
        });

    });

</script>
